{% extends "base.html" %}

{% block title %}Daily Observations - K.{% endblock %}

{% block meta_title %}Daily Observations - Gallery{% endblock %}
{% block meta_description %}Explore a collection of daily observations and moments captured by K.{% endblock %}
{% block meta_image %}
{% if pagination.items %}
{{ url_for('static', filename='gallery_images/' + pagination.items[0].filename, _external=True) }}
{% else %}
{{ super() }}
{% endif %}
{% endblock %}

{% block head %}
<style>
    /* --- Global Variables (Light Theme) --- */
    :root {
        --bg-color: #ffffff;
        --text-color: #333333;
        --accent-color: #000000;
        --subtle-gray: #f4f4f4;
        --gap-size: 15px;
        --overlay-bg: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
    }

    html {
        scroll-behavior: smooth;
        /* Smooth scroll when clicking month links */
    }

    /* --- Header & Nav --- */
    .gallery-header {
        padding: 60px 20px 20px;
        text-align: center;
    }

    .gallery-header h1 {
        font-weight: 700;
        letter-spacing: -1px;
        margin: 0 0 20px 0;
        font-size: 2.5rem;
        color: var(--accent-color);
    }

    .month-nav {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .month-nav a {
        text-decoration: none;
        color: #666;
        font-size: 0.9rem;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 20px;
        background-color: var(--subtle-gray);
        transition: all 0.2s ease;
    }

    .month-nav a:hover,
    .month-nav a.active {
        background-color: #333;
        color: #fff;
    }

    /* --- Upload Form --- */
    .upload-section {
        max-width: 600px;
        margin: 0 auto 40px;
        padding: 20px;
        background: var(--subtle-gray);
        border-radius: 8px;
        display: none;
        /* Hidden by default */
    }

    .upload-section.show {
        display: block;
        /* Show when toggled */
    }

    .upload-toggle-btn {
        background-color: #343a40;
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s ease;
        margin: 0 auto 20px;
        display: block;
    }

    .upload-toggle-btn:hover {
        background-color: #495057;
    }

    .upload-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .form-group label {
        font-weight: 500;
        font-size: 0.9rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .upload-btn {
        background-color: #343a40;
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s ease;
    }

    .upload-btn:hover {
        background-color: #495057;
    }

    /* --- Container --- */
    .gallery-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 0 20px 60px;
    }

    /* --- Month Section --- */
    .month-section {
        margin-bottom: 60px;
        scroll-margin-top: 100px;
        /* Offset for scrolling */
    }

    .month-header {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent-color);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--subtle-gray);
    }

    /* --- The Grid --- */
    .photo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: var(--gap-size);
    }

    /* --- Photo Card --- */
    .photo-card {
        position: relative;
        overflow: hidden;
        border-radius: 0px;
        /* Sharper edges for clean look */
        cursor: pointer;
        background-color: var(--subtle-gray);
        aspect-ratio: 16 / 9;
    }

    .photo-card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
        display: block;
    }

    /* --- Hover Overlay --- */
    .photo-info {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 20px;
        box-sizing: border-box;
        background: var(--overlay-bg);
        opacity: 0;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        transition: opacity 0.3s ease;
    }

    .text-content {
        color: white;
    }

    /* Hover State */
    .photo-card:hover img {
        transform: scale(1.05);
    }

    .photo-card:hover .photo-info {
        opacity: 1;
    }

    .photo-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .photo-date {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
    }

    /* --- Delete Button --- */
    .delete-btn {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(5px);
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .delete-btn:hover {
        background: white;
        color: #dc3545;
    }

    /* --- Heart Button --- */
    .heart-btn {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(5px);
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .heart-btn:hover {
        background: white;
        color: #ff4757;
    }

    .heart-btn.liked {
        background: white;
        color: #ff4757;
    }

    /* --- Modal (Single Page View) --- */
    .modal {
        display: none;
        /* Hidden by default */
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: #fff;
        overflow-y: auto;
    }

    .modal-content-wrapper {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
        display: flex;
        flex-direction: column;
        gap: 30px;
    }

    .close-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        font-size: 1rem;
        cursor: pointer;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-weight: bold;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .close-btn:hover {
        background: rgba(0, 0, 0, 1);
        transform: scale(1.1);
    }

    /* --- Navigation Buttons --- */
    .nav-btn {
        position: fixed;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10000;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .nav-btn:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: translateY(-50%) scale(1.1);
    }

    .nav-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .nav-btn-prev {
        left: 20px;
    }

    .nav-btn-next {
        right: 20px;
    }

    .modal-img {
        width: 100%;
        max-height: 80vh;
        object-fit: contain;
        background-color: #f9f9f9;
    }

    .modal-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }

    .modal-title {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
    }

    .modal-date {
        color: #888;
        margin-top: 5px;
    }

    /* --- Flash Messages --- */
    .flash-messages {
        max-width: 600px;
        margin: 20px auto;
        padding: 0 20px;
    }

    .flash-message {
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 10px;
        font-weight: 500;
    }

    .flash-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .flash-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .flash-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

    /* --- Mobile --- */
    @media (max-width: 600px) {
        .photo-grid {
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .month-nav {
            gap: 8px;
        }

        .month-nav a {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        /* Mobile Content Adjustments */
        .gallery-header {
            padding: 40px 15px 15px;
        }

        .gallery-header h1 {
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .gallery-container {
            padding: 0 15px 40px;
        }

        .month-section {
            margin-bottom: 40px;
        }

        .month-header {
            font-size: 1.3rem;
            margin-bottom: 15px;
        }

        .photo-card img {
            height: 100%;
            width: 100%;
        }

        .photo-info {
            padding: 15px;
        }

        .photo-title {
            font-size: 1rem;
        }

        .photo-date {
            font-size: 0.8rem;
        }

        .heart-btn,
        .delete-btn {
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .upload-section {
            margin: 0 15px 30px;
            padding: 15px;
        }
    }
</style>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ImageGallery",
  "name": "Daily Observations - K.",
  "description": "A collection of daily observations and moments captured by K.",
  "image": [
    {% for photo in pagination.items %}
    {
      "@type": "ImageObject",
      "contentUrl": "{{ url_for('static', filename='gallery_images/' + photo.filename, _external=True) }}",
      "thumbnailUrl": "{{ url_for('static', filename='gallery_images/thumbnails/' + photo.filename, _external=True) }}",
      "name": "{{ photo.title }}",
      "description": "{{ photo.description if photo.description else photo.title }}",
      "uploadDate": "{{ photo.created_at.isoformat() }}"
    }{{ "," if not loop.last }}
    {% endfor %}
  ]
}
</script>
{% endblock %}

{% block content %}
<!-- Flash Messages -->
<div class="flash-messages">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="flash-message flash-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}
</div>

<header class="gallery-header">
    <h1>Daily observations.</h1>

    <!-- Upload Toggle Button -->
    {% if current_user.is_authenticated %}
    <button class="upload-toggle-btn" onclick="toggleUploadForm()">üì∑ Upload Photo</button>

    <!-- Upload Form -->
    <div class="upload-section">
        <h3 style="margin-bottom: 20px; text-align: center;">Upload New Photo</h3>
        <form class="upload-form" action="{{ url_for('upload_photo') }}" method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label for="title">Photo Title</label>
                <input type="text" id="title" name="title" placeholder="Optional - will use filename if empty">
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="3"></textarea>
            </div>


            <div class="form-group">
                <label for="photo">Photo File *</label>
                <input type="file" id="photo" name="photo" accept=".png,.jpg,.jpeg,.gif" required>
            </div>

            <button type="submit" class="upload-btn">Upload Photo</button>
        </form>
    </div>
    {% endif %}

    <!-- Navigation Links -->
    <!-- Navigation Links -->
    <nav class="month-nav">
        <a href="{{ url_for('gallery') }}" class="{{ 'active' if not selected_year else '' }}">All</a>
        {% for year in years %}
        <a href="{{ url_for('gallery', year=year) }}"
            class="{{ 'active' if selected_year|string == year|string else '' }}">{{ year }}</a>
        {% endfor %}
    </nav>
</header>

<div class="gallery-container">
    {% if pagination.items %}

    <!-- Photos Grid -->
    <div class="photo-grid">
        {% for photo in pagination.items %}
        <!-- Photo Item -->
        <div class="photo-card" onclick="openModal(this)"
            data-full-image="{{ url_for('static', filename='gallery_images/' + photo.filename) }}"
            data-description="{{ photo.description if photo.description else '' }}">
            {% set thumbnail_path = 'gallery_images/thumbnails/' + photo.filename %}
            <img src="{{ url_for('static', filename=thumbnail_path) }}" alt="{{ photo.title }}" loading="lazy">
            <div class="photo-info">
                <div class="text-content">
                    <div class="photo-title">{{ photo.title }}</div>
                    <div class="photo-date">{{ photo.created_at.strftime('%b %d, %Y') }}</div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <!-- Heart Button -->
                    <button class="heart-btn" onclick="toggleHeart(event, this)">
                        <span>‚ô•</span> <span class="count">0</span>
                    </button>
                    <!-- Delete Button -->
                    {% if current_user.is_authenticated %}
                    <form action="{{ url_for('delete_photo', photo_id=photo.id) }}" method="POST"
                        style="display: inline;"
                        onsubmit="return confirm('Are you sure you want to delete this photo?')">
                        <button type="submit" class="delete-btn" onclick="event.stopPropagation()">
                            <span>üóëÔ∏è</span> Delete
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination Controls -->
    {% if pagination.pages > 1 %}
    <div class="pagination-container" style="margin-top: 40px; display: flex; justify-content: center; gap: 10px;">
        {% if pagination.has_prev %}
        <a href="{{ url_for('gallery', page=pagination.prev_num, year=selected_year) }}"
            class="btn btn-outline-dark">&laquo; Previous</a>
        {% endif %}

        <span class="btn btn-light disabled">Page {{ pagination.page }} of {{ pagination.pages }}</span>

        {% if pagination.has_next %}
        <a href="{{ url_for('gallery', page=pagination.next_num, year=selected_year) }}"
            class="btn btn-outline-dark">Next &raquo;</a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div style="text-align: center; padding: 60px 20px; color: #666;">
        <h3>No photos yet</h3>
        {% if current_user.is_authenticated %}
        <p>Upload your first photo using the form above!</p>
        {% else %}
        <p>Login to upload photos.</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- THE FULL PAGE MODAL TEMPLATE -->
<div id="photoModal" class="modal">
    <div class="modal-content-wrapper">
        <button class="close-btn" onclick="closeModal()" title="Close">&times;</button>

        <!-- Navigation Buttons -->
        <button class="nav-btn nav-btn-prev" id="prevBtn" onclick="navigatePhoto(-1)" title="Previous">&lsaquo;</button>
        <button class="nav-btn nav-btn-next" id="nextBtn" onclick="navigatePhoto(1)" title="Next">&rsaquo;</button>

        <img id="modalImg" class="modal-img" src="" alt="">
        <div class="modal-details">
            <div>
                <h2 id="modalTitle" class="modal-title">Title</h2>
                <div id="modalDate" class="modal-date">Date</div>
            </div>
            <!-- We duplicate the like button for the detailed view -->
            <button class="heart-btn" style="background:#f4f4f4; color:#333; font-size:1.1rem; padding: 12px 20px;">
                <span style="color:red">‚ô•</span> Supported by <span id="modalCount"
                    style="margin-left:5px; font-weight:bold;">0</span> people
            </button>
        </div>
        <div id="modalDescription" style="max-width: 600px; color: #666; line-height: 1.6; display: none;">
            <p id="modalDescriptionText"></p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- Upload Form Toggle ---
    function toggleUploadForm() {
        const uploadSection = document.querySelector('.upload-section');
        const toggleBtn = document.querySelector('.upload-toggle-btn');

        uploadSection.classList.toggle('show');

        // Update button text
        if (uploadSection.classList.contains('show')) {
            toggleBtn.textContent = '‚úñÔ∏è Cancel Upload';
        } else {
            toggleBtn.textContent = 'üì∑ Upload Photo';
        }
    }

    // --- Logic for the Heart/Support Counter ---
    function toggleHeart(event, btn) {
        // Prevent the click from triggering the photo modal
        event.stopPropagation();

        const countSpan = btn.querySelector('.count');
        let count = parseInt(countSpan.innerText);

        if (btn.classList.contains('liked')) {
            // Unlike
            count--;
            btn.classList.remove('liked');
        } else {
            // Like
            count++;
            btn.classList.add('liked');
        }

        countSpan.innerText = count;
    }

    // --- Logic for the Full Page Modal ---
    const modal = document.getElementById("photoModal");
    const modalImg = document.getElementById("modalImg");
    const modalTitle = document.getElementById("modalTitle");
    const modalDate = document.getElementById("modalDate");
    const modalCount = document.getElementById("modalCount");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    let currentPhotoIndex = 0;
    let allPhotoCards = [];

    function openModal(card) {
        // Get all photo cards for navigation
        allPhotoCards = Array.from(document.querySelectorAll('.photo-card'));
        currentPhotoIndex = allPhotoCards.indexOf(card);

        // Load the photo
        loadPhotoAtIndex(currentPhotoIndex);

        // Show modal
        modal.style.display = "block";
        // Disable background scrolling
        document.body.style.overflow = "hidden";

        // Update navigation buttons
        updateNavButtons();
    }

    function loadPhotoAtIndex(index) {
        const card = allPhotoCards[index];
        const fullImageSrc = card.getAttribute('data-full-image');
        const title = card.querySelector('.photo-title').innerText;
        const date = card.querySelector('.photo-date').innerText;
        const count = card.querySelector('.count').innerText;
        const description = card.getAttribute('data-description');

        // Populate modal
        modalImg.src = fullImageSrc;
        modalTitle.innerText = title;
        modalDate.innerText = date;
        modalCount.innerText = count;

        // Show description only if it exists
        const modalDescription = document.getElementById('modalDescription');
        const modalDescriptionText = document.getElementById('modalDescriptionText');
        if (description && description.trim() !== '') {
            modalDescriptionText.innerText = description;
            modalDescription.style.display = 'block';
        } else {
            modalDescription.style.display = 'none';
        }
    }

    function navigatePhoto(direction) {
        currentPhotoIndex += direction;

        // Ensure we stay within bounds
        if (currentPhotoIndex < 0) currentPhotoIndex = 0;
        if (currentPhotoIndex >= allPhotoCards.length) currentPhotoIndex = allPhotoCards.length - 1;

        loadPhotoAtIndex(currentPhotoIndex);
        updateNavButtons();
    }

    function updateNavButtons() {
        // Disable prev button if at first photo
        prevBtn.disabled = (currentPhotoIndex === 0);
        // Disable next button if at last photo
        nextBtn.disabled = (currentPhotoIndex === allPhotoCards.length - 1);
    }

    function closeModal() {
        modal.style.display = "none";
        // Re-enable background scrolling
        document.body.style.overflow = "auto";
    }

    // Close modal if clicking outside the image content
    window.onclick = function (event) {
        if (event.target == modal) {
            closeModal();
        }
    }


    // Ensure body overflow is reset when leaving the page
    window.addEventListener('beforeunload', () => {
        document.body.style.overflow = 'auto';
    });

    // --- Keyboard Navigation ---
    document.addEventListener('keydown', function (event) {
        if (modal.style.display === "block") {
            if (event.key === "ArrowLeft") {
                navigatePhoto(-1);
            } else if (event.key === "ArrowRight") {
                navigatePhoto(1);
            } else if (event.key === "Escape") {
                closeModal();
            }
        }
    });

</script>
{% endblock %}